<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR 코드 생성기 · Glassmorphism</title>
  <style>
    :root{
      --fg: #ffffff;
      --fg-dim: rgba(255,255,255,0.9);
      --fg-muted: rgba(255,255,255,0.6);
      --glass-bg: rgba(255,255,255,0.12);
      --glass-border: rgba(255,255,255,0.35);
      --accent: #60a5fa;
      --accent-2: #a78bfa;
      --danger: #ef4444;
      --ok: #22c55e;
    }

    body.light{
      --fg: #1f2937;
      --fg-dim: rgba(31,41,55,0.92);
      --fg-muted: rgba(31,41,55,0.5);
      --glass-bg: rgba(255,255,255,0.6);
      --glass-border: rgba(0,0,0,0.1);
      background: linear-gradient(135deg, #f9fafb, #e0e7ff);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: var(--fg);
      background: radial-gradient(1200px 800px at 20% 20%, #0ea5e9 0%, rgba(14,165,233,0.2) 60%, transparent 70%),
                  radial-gradient(900px 700px at 80% 30%, #6366f1 0%, rgba(99,102,241,0.15) 60%, transparent 70%),
                  linear-gradient(180deg, #0b1220 0%, #0b1220 100%);
      display: grid;
      place-items: center;
      padding: 24px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      padding: 8px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      color: var(--fg);
      transition: background 0.3s;
      line-height: 1;
    }

    .glass {
      width: 100%;
      max-width: 560px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 22px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.06);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      backdrop-filter: blur(14px) saturate(140%);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .title { margin: 0 0 6px; text-align: center; font-weight: 800; font-size: 22px; letter-spacing: -0.01em; }
    .subtitle{ text-align:center; margin: 0 0 18px; font-size: 12px; color: var(--fg-muted); }

    label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--fg-dim); }

    .grid{ display: grid; grid-template-columns: 1fr; gap: 14px; }
    .row2{ display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .input-wrap{ position: relative; }
    input[type="text"], select{
      width: 100%;
      padding: 14px 48px 14px 14px;
      font-size: 16px;
      color: var(--fg);
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      outline: none;
      transition: box-shadow .2s, border-color .2s, background .2s;
    }
    input::placeholder{ color: var(--fg-muted); }
    input:focus, select:focus{
      border-color: rgba(96,165,250,0.9);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.25);
      background: rgba(255,255,255,0.12);
    }

    .actions{ display:flex; gap:10px; flex-wrap: wrap; }
    .btn{
      appearance: none; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1);
      color: var(--fg); padding: 12px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; flex: 1;
      transition: transform .04s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,0.16); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: transparent; background: linear-gradient(135deg, var(--accent), var(--accent-2)); }

    .preview-card{
      margin-top: 18px; padding: 16px; border-radius: 16px; border: 1px dashed rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.06);
      display: grid; place-items: center;
    }
    .preview-inner{ display: grid; place-items: center; padding: 10px; background: rgba(0,0,0,0.08); border-radius: 12px; }
    #qrcode canvas{ border-radius: 4px; max-width: 100%; height: auto; display:block; }

/* ensure container doesn't overflow */
.preview-inner{ display: grid; place-items: center; padding: 10px; background: rgba(0,0,0,0.08); border-radius: 12px; width: 100%; }
.preview-card{ width: 100%; overflow: hidden; }

/* color swatches */
.swatches{ display:grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
.swatch{ position: relative; height: 38px; border-radius: 10px; border:1px solid var(--glass-border); cursor: pointer; outline: none; }
.swatch[aria-checked="true"]{ box-shadow: 0 0 0 3px rgba(96,165,250,0.35); border-color: rgba(96,165,250,0.9); }
.swatch::after{ content:""; position:absolute; inset:4px; border-radius:8px; background: var(--color); }
.swatch-label{ display:block; font-size:11px; color:var(--fg-muted); text-align:center; margin-top:6px; }

    .hint { margin-top: 10px; font-size: 12px; color: var(--fg-muted); text-align: right; }

    .orb{ position: fixed; border-radius: 50%; filter: blur(40px); opacity: 0.45; pointer-events:none;}
    .orb.one{ width: 220px; height: 220px; left: -60px; bottom: -40px; background: #22d3ee; }
    .orb.two{ width: 280px; height: 280px; right: -80px; top: -60px; background: #a78bfa; }

    .watermark { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); font-size: 14px; font-weight: 700; color: var(--fg-muted); opacity: 0.55; pointer-events: none; user-select: none; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }

    .diag { margin-top: 14px; font-size: 12px; display: grid; gap: 8px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.08); }
    .badge.ok::before{ content:""; width:8px; height:8px; border-radius:50%; background: var(--ok); }
    .badge.err::before{ content:""; width:8px; height:8px; border-radius:50%; background: var(--danger); }

    @media (max-width: 560px){
      .glass { padding: 22px; border-radius: 18px; }
      .row2{ grid-template-columns: 1fr; }
    }
  </style>
  <!-- Stable QR code library (davidshimjs) from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <button class="toggle" id="themeToggle" aria-label="테마 전환">🌙</button>
  <div class="orb one"></div>
  <div class="orb two"></div>

  <main class="glass" role="region" aria-label="QR 코드 생성기">
    <h1 class="title">QR 코드 생성기</h1>
    <p class="subtitle">링크(또는 텍스트)를 입력하면 즉시 QR 코드를 만들어 다운로드할 수 있어요.</p>

    <div class="grid" id="form">
      <div>
        <label for="url">링크 / 텍스트</label>
        <div class="input-wrap">
          <input id="url" type="text" autocomplete="off" placeholder="예: https://elice.io" />
        </div>
      </div>
      <div class="row2">
        <div>
          <label for="size">크기</label>
          <select id="size" aria-label="크기">
            <option value="160">160 px</option>
            <option value="256" selected>256 px (권장)</option>
            <option value="320">320 px</option>
            <option value="384">384 px</option>
            <option value="512">512 px</option>
          </select>
        </div>
        <div>
          <label for="ec">오류 보정(ECC)</label>
          <select id="ec" aria-label="오류 보정">
            <option value="L">L (7%)</option>
            <option value="M" selected>M (15%)</option>
            <option value="Q">Q (25%)</option>
            <option value="H">H (30%)</option>
          </select>
        </div>
      </div>
      <div class="row2">
        <div>
          <label for="margin">여백</label>
          <select id="margin">
            <option value="0">0 px</option>
            <option value="2">2 px</option>
            <option value="4" selected>4 px</option>
            <option value="8">8 px</option>
            <option value="16">16 px</option>
          </select>
        </div>
        <div>
          <label>색상</label>
          <div class="swatches" id="swatches" role="radiogroup" aria-label="전경 색상">
            <button class="swatch" role="radio" aria-checked="true" data-color="#000000" style="--color:#000000" title="검정"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#111827" style="--color:#111827" title="그레이900"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#1f2937" style="--color:#1f2937" title="그레이800"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#0f172a" style="--color:#0f172a" title="슬레이트900"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#0ea5e9" style="--color:#0ea5e9" title="하늘"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#10b981" style="--color:#10b981" title="그린"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#6366f1" style="--color:#6366f1" title="인디고"></button>
            <button class="swatch" role="radio" aria-checked="false" data-color="#a78bfa" style="--color:#a78bfa" title="보라"></button>
          </div>
          <span class="swatch-label">대표색 8가지 중 선택</span>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnGenerate">생성/갱신</button>
        <button class="btn" id="btnCopy">링크 복사</button>
        <button class="btn" id="btnDownload">PNG 다운로드</button>
        <button class="btn" id="btnDiag" title="간단 진단">진단 실행</button>
      </div>
    </div>

    <div class="preview-card" aria-live="polite">
      <div class="preview-inner">
        <div id="qrcode" aria-label="QR 미리보기"></div>
      </div>
    </div>
    <div class="diag" id="diag"></div>
    <p class="hint">Tip: 링크 앞에 스킴이 없다면 자동으로 <code>https://</code>를 붙여드려요.</p>
  </main>

  <div class="watermark">CXO 너구리 · QR</div>

  <script>
    // ----- Helpers -----
    const $ = (sel) => document.querySelector(sel);
    const urlInput = $('#url');
    const sizeSel = $('#size');
    const ecSel = $('#ec');
    const marginSel = $('#margin');
    const swatchWrap = document.getElementById('swatches');
    let currentColor = '#000000';
    const btnGen = $('#btnGenerate');
    const btnCopy = $('#btnCopy');
    const btnDl = $('#btnDownload');
    const btnDiag = $('#btnDiag');
    const box = $('#qrcode');
    const diag = $('#diag');
    const toggleBtn = document.getElementById('themeToggle');

    function normalizeUrl(str){
      const trimmed = (str||'').trim();
      if(!trimmed) return '';
      const hasScheme = /^([a-z][a-z0-9+.-]*:)?\/\//i.test(trimmed) || /^[a-z][a-z0-9+.-]*:/i.test(trimmed);
      if(!hasScheme && /\./.test(trimmed) && !/\s/.test(trimmed)){
        return 'https://' + trimmed;
      }
      return trimmed;
    }
    function validateColor(hex){ return /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(hex.trim()); }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style,{
        position:'fixed', bottom:'28px', left:'50%', transform:'translateX(-50%)',
        padding:'10px 14px', borderRadius:'12px', fontWeight:'700', fontSize:'12px',
        color:'var(--fg)', background:'rgba(0,0,0,0.55)', border:'1px solid rgba(255,255,255,0.25)',
        backdropFilter:'blur(8px) saturate(140%)', zIndex:9999
      });
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .4s'; setTimeout(()=>t.remove(),400); }, 1100);
    }

    // ----- QR Wrapper (replaces failing QRFactory) -----
    const CorrectLevelMap = { L: QRCode.CorrectLevel.L, M: QRCode.CorrectLevel.M, Q: QRCode.CorrectLevel.Q, H: QRCode.CorrectLevel.H };
    function ensureLib(){ return typeof QRCode !== 'undefined' && QRCode.CorrectLevel; }

    function renderQR(text,{size=256, ec='M', margin=4, color='#000000'}={}){
      if(!ensureLib()) throw new Error('QRCode library not loaded');
      // reset container
      box.innerHTML = '';
      const tmp = document.createElement('div');
      box.appendChild(tmp);
      const qr = new QRCode(tmp, {
        text,
        width: size,
        height: size,
        colorDark: color,
        colorLight: '#ffffff',
        correctLevel: CorrectLevelMap[ec] || QRCode.CorrectLevel.M,
      });
      // apply margin by wrapping canvas
      const canvas = tmp.querySelector('canvas');
      if(canvas && margin>0){
        const withMargin = document.createElement('canvas');
        const s = size + margin*2;
        withMargin.width = s; withMargin.height = s;
        const ctx = withMargin.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,s,s);
        ctx.drawImage(canvas, margin, margin);
        box.replaceChildren(withMargin);
        return withMargin;
      }
      // if no margin, move raw canvas into box
      if(canvas){ box.replaceChildren(canvas); return canvas; }
      // Fallback to image element created by lib
      const img = tmp.querySelector('img');
      if(img){ box.replaceChildren(img); return img; }
      throw new Error('QR render failed');
    }

    // ----- Actions -----
    function generate(){
      const raw = urlInput.value;
      const text = normalizeUrl(raw);
      if(!text){
        box.innerHTML = '<span style="color:var(--fg-muted);font-size:13px">링크 또는 텍스트를 입력하세요.</span>';
        return;
      }
      const size = parseInt(sizeSel.value,10);
      const ec = ecSel.value;
      const margin = parseInt(marginSel.value,10);
      const color = currentColor || '#000000';
      try{
        const node = renderQR(text,{size, ec, margin, color});
        box.dataset.text = text;
      }catch(err){
        box.innerHTML = `<span style="color:var(--danger);font-size:13px">오류: ${err.message}</span>`;
      }
    }

    function downloadPNG(){
      const c = box.querySelector('canvas');
      if(!c){ generate(); }
      const cnv = box.querySelector('canvas');
      if(!cnv) return;
      const url = cnv.toDataURL('image/png');
      const a = document.createElement('a');
      const safe = (box.dataset.text||'qr').replace(/[^\w가-힣-_]+/g,'_').slice(0,60) || 'qr';
      a.href = url; a.download = safe + '.png';
      document.body.appendChild(a); a.click(); a.remove();
    }

    async function copyLink(){
      const val = normalizeUrl(urlInput.value);
      if(!val) return;
      try{ await navigator.clipboard.writeText(val); toast('링크를 복사했어요'); }
      catch(e){ toast('복사에 실패했어요'); }
    }

    // ----- Diagnostics (Test Cases) -----
    function addBadge(ok, label){
      const b = document.createElement('span');
      b.className = 'badge ' + (ok ? 'ok' : 'err');
      b.textContent = label;
      diag.appendChild(b);
    }
    function runDiagnostics(){
      diag.innerHTML = '';
      // Test 0: library present
      addBadge(ensureLib(), '라이브러리 로드');
      if(!ensureLib()){
        addBadge(false, '로드 실패: 네트워크 차단?');
        return;
      }
      // Test 1: simple URL
      try{ renderQR('https://example.com',{size:160, ec:'M', margin:4, color:'#000000'}); addBadge(true,'생성: 기본 URL'); }
      catch(e){ addBadge(false,'생성 실패: 기본 URL'); }
      // Test 2: autoscheme
      try{ const t = normalizeUrl('elice.io'); renderQR(t,{size:160, ec:'Q', margin:2, color:'#000'}); addBadge(/^https:\/\//.test(t),'스킴 자동 보정'); }
      catch(e){ addBadge(false,'스킴 보정 실패'); }
      // Test 3: color validation
      addBadge(validateColor('#123abc'),'색상 유효성 #123abc');
      addBadge(!validateColor('red'),'색상 거부 red');
      // restore UI
      box.innerHTML = '<span style="color:var(--fg-muted);font-size:13px">진단 완료. 필요 시 다시 생성하세요.</span>';
    }

    // ----- Events -----
    // swatch events
    if (swatchWrap){
      swatchWrap.addEventListener('click', (e)=>{
        const btn = e.target.closest('.swatch');
        if(!btn) return;
        [...swatchWrap.querySelectorAll('.swatch')].forEach(b=>b.setAttribute('aria-checked','false'));
        btn.setAttribute('aria-checked','true');
        currentColor = btn.dataset.color;
      });
      swatchWrap.addEventListener('keydown', (e)=>{
        const items = [...swatchWrap.querySelectorAll('.swatch')];
        const idx = items.findIndex(i=>i.getAttribute('aria-checked')==='true');
        let next = idx;
        if(e.key==='ArrowRight') next = (idx+1)%items.length;
        if(e.key==='ArrowLeft') next = (idx-1+items.length)%items.length;
        if(next!==idx){
          items[idx].setAttribute('aria-checked','false');
          items[next].setAttribute('aria-checked','true');
          items[next].focus();
          currentColor = items[next].dataset.color;
          e.preventDefault();
        }
      });
    }

    // ----- Events -----
    btnGen.addEventListener('click', (e)=>{ e.preventDefault(); generate(); });
    btnDl.addEventListener('click', (e)=>{ e.preventDefault(); downloadPNG(); });
    btnCopy.addEventListener('click', (e)=>{ e.preventDefault(); copyLink(); });
    btnDiag.addEventListener('click', (e)=>{ e.preventDefault(); runDiagnostics(); });
    urlInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ generate(); }});

    // Theme toggle
    toggleBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('light');
      toggleBtn.textContent = document.body.classList.contains('light') ? '☀️' : '🌙';
    });

    // Initial state & smoke check
    box.innerHTML = '<span style="color:var(--fg-muted);font-size:13px">QR 미리보기가 여기에 표시됩니다.</span>';
    if(!ensureLib()){
      const warn = document.createElement('div');
      warn.className = 'badge err';
      warn.textContent = '경고: QR 라이브러리 로드 실패 (네트워크 정책/차단 확인)';
      diag.appendChild(warn);
    }
  </script>
</body>
</html>
